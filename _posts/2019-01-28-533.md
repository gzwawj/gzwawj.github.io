---
layout: post
title:  PHP操作MongoDB数据库的示例
date:   2019/01/28 13:29
categories:  程序开发
tags: php 
excerpt: Mognodb数据库连接  默认格式  $m = new Mongo(); //这里采用默认连接本机的27017端口，当然也可以连接远程主机如  192.168.0.4:27017,如果端口是27017，端口可以省略。   标准连接  $m = new Mongo("mongodb://${username}:${password}@localhost");   实例：  $m = new Mon
comment: true
---
* content
{:top}

<h2>Mognodb数据库连接</h2>

<h4>默认格式</h4>

<pre><code class="language-php ">$m = new Mongo();
//这里采用默认连接本机的27017端口，当然也可以连接远程主机如  192.168.0.4:27017,如果端口是27017，端口可以省略。
</code></pre>

<h4>标准连接</h4>

<pre><code class="language-php ">$m = new Mongo("mongodb://${username}:${password}@localhost");
</code></pre>

实例：

<pre><code class="language-php ">$m = new Mongo("mongodb://127.0.0.1:27017/admin:admin");
</code></pre>

数据库的用户名和密码都是admin

<h2>数据库操作</h2>

<h4>插入数据</h4>

<pre><code class="language-php ">&lt;?php
//这里采用默认连接本机的27017端口，当然你也可以连接远程主机如192.168.0.4:27017
//如果端口是27017，端口可以省略
$m = new Mongo("mongodb://127.0.0.1:27017/admin:admin");
//选择comedy数据库，如果以前没该数据库会自动创建，也可以用$m-&gt;selectDB("comedy");
$db = $m-&gt;comedy;
//选择comedy里面的collection集合，相当于RDBMS里面的表，也可以使用
$collection = $db-&gt;collection;
$db-&gt;selectCollection("collection");
/*********添加一个元素**************/
$obj = array("title" =&gt; "php1", "author" =&gt; "Bill Watterson");
//将$obj 添加到$collection 集合中
$collection-&gt;insert($obj);
/*********添加另一个元素**************/
$obj = array("title" =&gt; "huaibei", "online" =&gt; true);
$collection-&gt;insert($obj);
//$query = array("title" =&gt; "huaibei");
$query = array( "_id" =&gt; $obj['_id'] );
$cursor = $collection-&gt;find($query);
//遍历所有集合中的文档
foreach ($cursor as $obj) {
   echo $obj["title"] . "\n";
   echo $obj["_id"] . "\n";
}
//断开MongoDB连接
$m-&gt;close();
</code></pre>

<h4>带条件的查询</h4>

<pre><code class="language-text ">mysql: id = 123
mongo: array(‘id’=&gt;123)
mysql: name link ’%bar%’
mongo: array(‘name’ =&gt; new MongoRegex(‘/.*bar.*/i’))
mysql: where id &gt; 10
mongo: array(‘id’ =&gt; array(‘$gt’ =&gt; 10))
mysql: where id &gt;= 10
mongo: array(‘id’ =&gt; array(‘$gte’ =&gt; 10))
mysql: where id &lt; 10
mongo: array(‘id’ =&gt; array(‘$lt’ =&gt; 10))
mysql: where id &lt;= 10
mongo: array(‘id’ =&gt; array(‘$lte’ =&gt; 10))
mysql: where id &gt; 1 and id &lt; 10
mongo: array(‘id’ =&gt; array(‘$gt’ =&gt; 1,’$lt’ =&gt; 10))
mysql: where id &lt;&gt; 10
mongo: array(‘id’ =&gt; array(‘$ne’ =&gt; 10))
mysql: where id in(123)
mongo: array(‘id’ =&gt; array(‘$in’ =&gt; array(1,2,3)))
mysql: where id not in(123)
mongo: array(‘id’ =&gt; array(‘$nin’ =&gt; array(1,2,3)))
mysql: where id = 2 or id = 9
mongo: array(‘id’ =&gt; array(‘$or’ =&gt; array(array(‘id’=&gt;2),array(‘id’=&gt;9))))
mysql: order by name asc
mongo: array(‘sort’=&gt;array(‘name’=&gt;1))
mysql: order by name desc
mongo: array(‘sort’=&gt;array(‘name’=&gt;-1))
mysql: limit 0,2
mongo: array(‘limit’=&gt;array(‘offset’=&gt;0,’rows’=&gt;2))
mysql: select name,email
mongo: array(‘name’,'email’)
mysql: select count(name)
mongo: array(‘COUNT’) //注意：COUNT为大写
</code></pre>

查询时，每个Object插入时都会自动生成一个独特的_id,它相当于RDBMS中的主键，用于查询时非常方便 （_id每一都不同，很像自动增加的id）

<pre><code class="language-php ">&lt;?php
$param = array("name" =&gt; "joe");
$collection-&gt;insert($param);
$joe = $collection-&gt;findOne(array("_id" =&gt; $param['_id']));
print_R($joe);
$m-&gt;close();
</code></pre>

返回结果：Array ( [_id] => MongoId Object ( [$id] => 4fd30e21870da83416000002 ) [name] => joe )

<h4>更改字段值</h4>

<pre><code class="language-php ">&lt;?php
$sign = array("title" =&gt; 'php1');
$param = array("title" =&gt; 'php1','author'=&gt;'test');
$joe = $collection-&gt;update($sign, $param);
</code></pre>

<h4>删除一个数据库</h4>

<pre><code class="language-php ">$m -&gt; dropDB(“comedy”);
</code></pre>

<h4>列出所有可用数据库</h4>

<pre><code class="language-php ">$m-&gt;listDBs();   //无返回值
</code></pre>

<h4>创建一个MongoDB对象</h4>

<pre><code class="language-php ">&lt;?php
$mo = new Mongo();
$db = new MongoDB($mo,’dbname’);//通过创建方式获得一个MongoDB对象
</code></pre>

<h4>删除当前DB</h4>

<pre><code class="language-php ">&lt;?php
$db = $mo-&gt;dbname;
$db-&gt;drop();
</code></pre>

<h4>获得当前数据库名</h4>

<pre><code class="language-php ">&lt;?php
$db = $mo-&gt;dbname;
$db-&gt;_tostring();
</code></pre>

<h4>选择想要的collection:</h4>

<pre><code class="language-php ">//A:
$mo = new Mongo();
$coll = $mo-&gt;dbname-&gt;collname;//获得一个collection对象
//B：
$db = $mo-&gt;selectDB(’dbname’);
$coll = $db-&gt;collname;
//C:
$db = $mo-&gt;dbname;
$coll = $db-&gt;collname;
//D:
$db = $mo-&gt;dbname;
$coll = $db-&gt;selectCollectoin(’collname’);//获得一个collection对象
</code></pre>

<h4>插入数据（MongoCollection对象</h4>

<pre><code class="language-php ">$coll = $mo-&gt;db-&gt;foo;
$a = array(’a’=&gt;’b’);
$options = array(’safe’=&gt;true);
$rs  =$coll-&gt;insert($a,$options);
</code></pre>

<h4>删除数据库中的记录（MongoCollection对象）</h4>

<pre><code class="language-php ">$coll = $mo-&gt;db-&gt;coll;
$c = array(’a’=&gt;1,’s’=&gt;array(’$lt’=&gt;100));
$options = array(’safe’=&gt;true);
$rs = $coll-&gt;remove($c,$options);
</code></pre>

<h4>更新数据库中的记录（MongoCollection对象）</h4>

<pre><code class="language-php ">$coll = $mo-&gt;db-&gt;coll;
$c = array(’a’=&gt;1,’s’=&gt;array(’$lt’=&gt;100));
$newobj = array(’e’=&gt;’f’,’x’=&gt;’y’);
$options = array(’safe’=&gt;true,’multiple’=&gt;true);
$rs = $coll-&gt;remove($c,$newobj,$options);
</code></pre>

<h4>查询collection获得单条记录（MongoCollection类）</h4>

<pre><code class="language-php ">$coll = $mo-&gt;db-&gt;coll;
$query = array(’s’=&gt;array(’$lt’=&gt;100));
$fields = array(’a’=&gt;true,’b’=&gt;true);
$rs = $coll-&gt;findOne($query,$fields);
</code></pre>

<h4>查询collection获得多条记录（MongoCollection类）</h4>

<pre><code class="language-php ">$coll = $mo-&gt;db-&gt;coll;
$query = array(’s’=&gt;array(’$lt’=&gt;100));
$fields = array(’a’=&gt;true,’b’=&gt;true);
$cursor = $coll-&gt;find($query,$fields);
//排序
$cursor-&gt;sort(array(‘字段’=&gt;-1));(-1倒序，1正序)
//跳过部分记录
$cursor-&gt;skip(100);跳过100行
//只显示部分记录
$cursor-&gt;limit(100);只显示100行
返回一个游标记录对象MongoCursor。
</code></pre>

<h4>针对游标对象MongoCursor的操作(MongoCursor类)</h4>

<pre><code class="language-php ">$cursor = $coll-&gt;find($query,$fields);
while($cursor-&gt;hasNext()){
$r = $cursor-&gt;getNext();
var_dump($r);
}
//或者
$cursor = $coll-&gt;find($query,$fields);
foreache($cursor as $k=&gt;$v){
var_dump($v);
}
//或者
$cursor = $coll-&gt;find($query,$fields);
$array= iterator_to_array($cursor);
</code></pre>
    