---
layout: post
title:  PHP导入导出mysql为sql文件的方法
date:   2018/05/14 20:18
categories:   数据管理
tags: php mysql 
excerpt: 实现功能：  实现mysql数据库分卷备份,选择表进行备份,实现单个sql文件及分卷sql导入。  分卷导出思路：统计sql语句变量的长度，按1个字符当成1 字节比较，如果大于设定分卷大小，则写入一个sql文件（我也不知道这样统计是否稳当，这也是借鉴其他的人的）。  分卷导入思路：按行读取sql文件，将每一行当作完整的sql语句存到数组再循环执行插入数据库就可以了，但是在创建表语句分了多行，这个需
comment: true
---
* content
{:top}

<h4>实现功能：</h4>

实现mysql数据库分卷备份,选择表进行备份,实现单个sql文件及分卷sql导入。

分卷导出思路：统计sql语句变量的长度，按1个字符当成1 字节比较，如果大于设定分卷大小，则写入一个sql文件（我也不知道这样统计是否稳当，这也是借鉴其他的人的）。

分卷导入思路：按行读取sql文件，将每一行当作完整的sql语句存到数组再循环执行插入数据库就可以了，但是在创建表语句分了多行，这个需要单独处理（就这个花了我好长时间的）；

（哇，感觉文章好长啊！主要是那个类文件给占用了）。

更新时间： 2012年10月6日

更新说明：

1.去除sql导入的时候排除sql文件里面的注释'-- ' 从而解决sql中单双引号不能导入

2.单行读取后的sql直接执行，避免重新将sql语句组合到数组中再从数组中读取导入sql，提高效率

下载地址: https://github.com/yanue/Dbmanage

<h4>导出后的sql文件格式如下：</h4>

<pre data-language=><code class="language-mysql ">--
-- MySQL database dump
-- Created by DBManage class, Power By yanue. 
-- http://www.yanue.net 
--
-- 主机: localhost
-- 生成日期: 2012 年  10 月 06 日 22:32
-- MySQL版本: 5.1.50-community
-- PHP 版本: 5.3.9-ZS5.6.0

--
-- 数据库: `test`
--

-- -------------------------------------------------------

--
-- 表的结构aa
--

DROP TABLE IF EXISTS `aa`;
CREATE TABLE `aa` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `content` text NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;

--
-- 转存表中的数据 aa
--

INSERT INTO `aa` VALUES('1','&lt;p id="test"&gt;&lt;span class='hahh' style="line-height:;"&gt;我是测试数据 呵呵&lt;/span&gt;&lt;/p&gt;');
</code></pre>

<h4>下面是类代码：</h4>

<pre data-language=><code class="language-php ">&lt;?php
/**
 * @author yanue
 * @copyright  Copyright (c) 2012 yanue.net
 * @link  http://yanue.net/archives/174.html
 * @version 1.1
 * 创建时间： 2012年5月21日

更新时间： 2012年10月6日
更新说明： 1.去除sql导入的时候排除sql文件里面的注释'-- ' 从而解决sql中单双引号不能导入
2.单行读取后的sql直接执行，避免重新将sql语句组合到数组中再从数组中读取导入sql，提高效率

 * 说明：分卷文件是以_v1.sql为结尾(20120522021241_all_v1.sql)
 * 功能：实现mysql数据库分卷备份,选择表进行备份,实现单个sql文件及分卷sql导入
 * 使用方法：
 *
 * ------1. 数据库备份（导出）------------------------------------------------------------
//分别是主机，用户名，密码，数据库名，数据库编码
$db = new DBManage ( 'localhost', 'root', 'root', 'test', 'utf8' );
// 参数：备份哪个表(可选),备份目录(可选，默认为backup),分卷大小(可选,默认2000，即2M)
$db-&gt;backup ();
 * ------2. 数据库恢复（导入）------------------------------------------------------------
//分别是主机，用户名，密码，数据库名，数据库编码
$db = new DBManage ( 'localhost', 'root', 'root', 'test', 'utf8' );
//参数：sql文件
$db-&gt;restore ( './backup/20120516211738_all_v1.sql');
 *----------------------------------------------------------------------
 */
class DbManage {
    var $db; // 数据库连接
    var $database; // 所用数据库
    var $sqldir; // 数据库备份文件夹
    // 换行符
    private $ds = "n";
    // 存储SQL的变量
    public $sqlContent = "";
    // 每条sql语句的结尾符
    public $sqlEnd = ";";

    /**
     * 初始化
     *
     * @param string $host
     * @param string $username
     * @param string $password
     * @param string $database
     * @param string $charset
     */
    function __construct($host = 'localhost', $username = 'root', $password = '', $database = 'test', $charset = 'utf8') {
        $this-&gt;host = $host;
        $this-&gt;username = $username;
        $this-&gt;password = $password;
        $this-&gt;database = $database;
        $this-&gt;charset = $charset;
        set_time_limit(0);//无时间限制
@ob_end_flush();
        // 连接数据库
        $this-&gt;db = @mysql_connect ( $this-&gt;host, $this-&gt;username, $this-&gt;password ) or die( '&lt;p class="dbDebug"&gt;&lt;span class="err"&gt;Mysql Connect Error : &lt;/span&gt;'.mysql_error().'&lt;/p&gt;');
        // 选择使用哪个数据库
        mysql_select_db ( $this-&gt;database, $this-&gt;db ) or die('&lt;p class="dbDebug"&gt;&lt;span class="err"&gt;Mysql Connect Error:&lt;/span&gt;'.mysql_error().'&lt;/p&gt;');
        // 数据库编码方式
        mysql_query ( 'SET NAMES ' . $this-&gt;charset, $this-&gt;db );

    }

    /*
     * 新增查询数据库表
     */
    function getTables() {
        $res = mysql_query ( "SHOW TABLES" );
        $tables = array ();
        while ( $row = mysql_fetch_array ( $res ) ) {
            $tables [] = $row [0];
        }
        return $tables;
    }

    /*
     *
     * ------------------------------------------数据库备份start----------------------------------------------------------
     */

    /**
     * 数据库备份
     * 参数：备份哪个表(可选),备份目录(可选，默认为backup),分卷大小(可选,默认2000，即2M)
     *
     * @param $string $dir
     * @param int $size
     * @param $string $tablename
     */
    function backup($tablename = '', $dir, $size) {
        $dir = $dir ? $dir : './backup/';
        // 创建目录
        if (! is_dir ( $dir )) {
            mkdir ( $dir, 0777, true ) or die ( '创建文件夹失败' );
        }
        $size = $size ? $size : 2048;
        $sql = '';
        // 只备份某个表
        if (! empty ( $tablename )) {
            if(@mysql_num_rows(mysql_query("SHOW TABLES LIKE '".$tablename."'")) == 1) {
             } else {
                $this-&gt;_showMsg('表-&lt;b&gt;' . $tablename .'&lt;/b&gt;-不存在，请检查！',true);
                die();
            }
            $this-&gt;_showMsg('正在备份表 &lt;span class="imp"&gt;' . $tablename.'&lt;/span&gt;');
            // 插入dump信息
            $sql = $this-&gt;_retrieve ();
            // 插入表结构信息
            $sql .= $this-&gt;_insert_table_structure ( $tablename );
            // 插入数据
            $data = mysql_query ( "select * from " . $tablename );
            // 文件名前面部分
            $filename = date ( 'YmdHis' ) . "_" . $tablename;
            // 字段数量
            $num_fields = mysql_num_fields ( $data );
            // 第几分卷
            $p = 1;
            // 循环每条记录
            while ( $record = mysql_fetch_array ( $data ) ) {
                // 单条记录
                $sql .= $this-&gt;_insert_record ( $tablename, $num_fields, $record );
                // 如果大于分卷大小，则写入文件
                if (strlen ( $sql ) &gt;= $size * 1024) {
                    $file = $filename . "_v" . $p . ".sql";
                    if ($this-&gt;_write_file ( $sql, $file, $dir )) {
                        $this-&gt;_showMsg("表-&lt;b&gt;" . $tablename . "&lt;/b&gt;-卷-&lt;b&gt;" . $p . "&lt;/b&gt;-数据备份完成,备份文件 [ &lt;span class='imp'&gt;" .$dir . $file ."&lt;/span&gt; ]");
                    } else {
                        $this-&gt;_showMsg("备份表 -&lt;b&gt;" . $tablename . "&lt;/b&gt;- 失败",true);
                        return false;
                    }
                    // 下一个分卷
                    $p ++;
                    // 重置$sql变量为空，重新计算该变量大小
                    $sql = "";
                }
            }
            // 及时清除数据
            unset($data,$record);
            // sql大小不够分卷大小
            if ($sql != "") {
                $filename .= "_v" . $p . ".sql";
                if ($this-&gt;_write_file ( $sql, $filename, $dir )) {
                    $this-&gt;_showMsg( "表-&lt;b&gt;" . $tablename . "&lt;/b&gt;-卷-&lt;b&gt;" . $p . "&lt;/b&gt;-数据备份完成,备份文件 [ &lt;span class='imp'&gt;" .$dir . $filename ."&lt;/span&gt; ]");
                } else {
                    $this-&gt;_showMsg("备份卷-&lt;b&gt;" . $p . "&lt;/b&gt;-失败&lt;br /&gt;");
                    return false;
                }
            }
            $this-&gt;_showMsg("恭喜您! &lt;span class='imp'&gt;备份成功&lt;/span&gt;");
        } else {
            $this-&gt;_showMsg('正在备份');
            // 备份全部表
            if ($tables = mysql_query ( "show table status from " . $this-&gt;database )) {
                $this-&gt;_showMsg("读取数据库结构成功！");
            } else {
                $this-&gt;_showMsg("读取数据库结构失败！");
                exit ( 0 );
            }
            // 插入dump信息
            $sql .= $this-&gt;_retrieve ();
            // 文件名前面部分
            $filename = date ( 'YmdHis' ) . "_all";
            // 查出所有表
            $tables = mysql_query ( 'SHOW TABLES' );
            // 第几分卷
            $p = 1;
            // 循环所有表
            while ( $table = mysql_fetch_array ( $tables ) ) {
                // 获取表名
                $tablename = $table [0];
                // 获取表结构
                $sql .= $this-&gt;_insert_table_structure ( $tablename );
                $data = mysql_query ( "select * from " . $tablename );
                $num_fields = mysql_num_fields ( $data );

                // 循环每条记录
                while ( $record = mysql_fetch_array ( $data ) ) {
                    // 单条记录
                    $sql .= $this-&gt;_insert_record ( $tablename, $num_fields, $record );
                    // 如果大于分卷大小，则写入文件
                    if (strlen ( $sql ) &gt;= $size * 1000) {

                        $file = $filename . "_v" . $p . ".sql";
                        // 写入文件
                        if ($this-&gt;_write_file ( $sql, $file, $dir )) {
                            $this-&gt;_showMsg("-卷-&lt;b&gt;" . $p . "&lt;/b&gt;-数据备份完成,备份文件 [ &lt;span class='imp'&gt;".$dir.$file."&lt;/span&gt; ]");
                        } else {
                            $this-&gt;_showMsg("卷-&lt;b&gt;" . $p . "&lt;/b&gt;-备份失败!",true);
                            return false;
                        }
                        // 下一个分卷
                        $p ++;
                        // 重置$sql变量为空，重新计算该变量大小
                        $sql = "";
                    }
                }
            }
            // sql大小不够分卷大小
            if ($sql != "") {
                $filename .= "_v" . $p . ".sql";
                if ($this-&gt;_write_file ( $sql, $filename, $dir )) {
                    $this-&gt;_showMsg("-卷-&lt;b&gt;" . $p . "&lt;/b&gt;-数据备份完成,备份文件 [ &lt;span class='imp'&gt;".$dir.$filename."&lt;/span&gt; ]");
                } else {
                    $this-&gt;_showMsg("卷-&lt;b&gt;" . $p . "&lt;/b&gt;-备份失败",true);
                    return false;
                }
            }
            $this-&gt;_showMsg("恭喜您! &lt;span class='imp'&gt;备份成功&lt;/span&gt;");
        }
    }

    //  及时输出信息
    private function _showMsg($msg,$err=false){
        $err = $err ? "&lt;span class='err'&gt;ERROR:&lt;/span&gt;" : '' ;
        echo "&lt;p class='dbDebug'&gt;".$err . $msg."&lt;/p&gt;";
        flush();

    }

    /**
     * 插入数据库备份基础信息
     *
     * @return string
     */
    private function _retrieve() {
        $value = '';
        $value .= '--' . $this-&gt;ds;
        $value .= '-- MySQL database dump' . $this-&gt;ds;
        $value .= '-- Created by DbManage class, Power By yanue. ' . $this-&gt;ds;
        $value .= '-- http://yanue.net ' . $this-&gt;ds;
        $value .= '--' . $this-&gt;ds;
        $value .= '-- 主机: ' . $this-&gt;host . $this-&gt;ds;
        $value .= '-- 生成日期: ' . date ( 'Y' ) . ' 年  ' . date ( 'm' ) . ' 月 ' . date ( 'd' ) . ' 日 ' . date ( 'H:i' ) . $this-&gt;ds;
        $value .= '-- MySQL版本: ' . mysql_get_server_info () . $this-&gt;ds;
        $value .= '-- PHP 版本: ' . phpversion () . $this-&gt;ds;
        $value .= $this-&gt;ds;
        $value .= '--' . $this-&gt;ds;
        $value .= '-- 数据库: `' . $this-&gt;database . '`' . $this-&gt;ds;
        $value .= '--' . $this-&gt;ds . $this-&gt;ds;
        $value .= '-- -------------------------------------------------------';
        $value .= $this-&gt;ds . $this-&gt;ds;
        return $value;
    }

    /**
     * 插入表结构
     *
     * @param unknown_type $table
     * @return string
     */
    private function _insert_table_structure($table) {
        $sql = '';
        $sql .= "--" . $this-&gt;ds;
        $sql .= "-- 表的结构" . $table . $this-&gt;ds;
        $sql .= "--" . $this-&gt;ds . $this-&gt;ds;

        // 如果存在则删除表
        $sql .= "DROP TABLE IF EXISTS `" . $table . '`' . $this-&gt;sqlEnd . $this-&gt;ds;
        // 获取详细表信息
        $res = mysql_query ( 'SHOW CREATE TABLE `' . $table . '`' );
        $row = mysql_fetch_array ( $res );
        $sql .= $row [1];
        $sql .= $this-&gt;sqlEnd . $this-&gt;ds;
        // 加上
        $sql .= $this-&gt;ds;
        $sql .= "--" . $this-&gt;ds;
        $sql .= "-- 转存表中的数据 " . $table . $this-&gt;ds;
        $sql .= "--" . $this-&gt;ds;
        $sql .= $this-&gt;ds;
        return $sql;
    }

    /**
     * 插入单条记录
     *
     * @param string $table
     * @param int $num_fields
     * @param array $record
     * @return string
     */
    private function _insert_record($table, $num_fields, $record) {
        // sql字段逗号分割
        $insert = '';
        $comma = "";
        $insert .= "INSERT INTO `" . $table . "` VALUES(";
        // 循环每个子段下面的内容
        for($i = 0; $i &lt; $num_fields; $i ++) {
            $insert .= ($comma . "'" . mysql_escape_string ( $record [$i] ) . "'");
            $comma = ",";
        }
        $insert .= ");" . $this-&gt;ds;
        return $insert;
    }

    /**
     * 写入文件
     *
     * @param string $sql
     * @param string $filename
     * @param string $dir
     * @return boolean
     */
    private function _write_file($sql, $filename, $dir) {
        $dir = $dir ? $dir : './backup/';
        // 创建目录
        if (! is_dir ( $dir )) {
            mkdir ( $dir, 0777, true );
        }
        $re = true;
        if (! @$fp = fopen ( $dir . $filename, "w+" )) {
            $re = false;
            $this-&gt;_showMsg("打开sql文件失败！",true);
        }
        if (! @fwrite ( $fp, $sql )) {
            $re = false;
            $this-&gt;_showMsg("写入sql文件失败，请文件是否可写",true);
        }
        if (! @fclose ( $fp )) {
            $re = false;
            $this-&gt;_showMsg("关闭sql文件失败！",true);
        }
        return $re;
    }

    /*
     *
     * -------------------------------上：数据库导出-----------分割线----------下：数据库导入--------------------------------
     */

    /**
     * 导入备份数据
     * 说明：分卷文件格式20120516211738_all_v1.sql
     * 参数：文件路径(必填)
     *
     * @param string $sqlfile
     */
    function restore($sqlfile) {
        // 检测文件是否存在
        if (! file_exists ( $sqlfile )) {
            $this-&gt;_showMsg("sql文件不存在！请检查",true);
            exit ();
        }
        $this-&gt;lock ( $this-&gt;database );
        // 获取数据库存储位置
        $sqlpath = pathinfo ( $sqlfile );
        $this-&gt;sqldir = $sqlpath ['dirname'];
        // 检测是否包含分卷，将类似20120516211738_all_v1.sql从_v分开,有则说明有分卷
        $volume = explode ( "_v", $sqlfile );
        $volume_path = $volume [0];
        $this-&gt;_showMsg("请勿刷新及关闭浏览器以防止程序被中止，如有不慎！将导致数据库结构受损");
        $this-&gt;_showMsg("正在导入备份数据，请稍等！");
        if (empty ( $volume [1] )) {
            $this-&gt;_showMsg ( "正在导入sql：&lt;span class='imp'&gt;" . $sqlfile . '&lt;/span&gt;');
            // 没有分卷
            if ($this-&gt;_import ( $sqlfile )) {
                $this-&gt;_showMsg( "数据库导入成功！");
            } else {
                 $this-&gt;_showMsg('数据库导入失败！',true);
                exit ();
            }
        } else {
            // 存在分卷，则获取当前是第几分卷，循环执行余下分卷
            $volume_id = explode ( ".sq", $volume [1] );
            // 当前分卷为$volume_id
            $volume_id = intval ( $volume_id [0] );
            while ( $volume_id ) {
                $tmpfile = $volume_path . "_v" . $volume_id . ".sql";
                // 存在其他分卷，继续执行
                if (file_exists ( $tmpfile )) {
                    // 执行导入方法
                    $this-&gt;msg .= "正在导入分卷 $volume_id ：&lt;span style='color:#f00;'&gt;" . $tmpfile . '&lt;/span&gt;&lt;br /&gt;';
                    if ($this-&gt;_import ( $tmpfile )) {

                    } else {
                        $volume_id = $volume_id ? $volume_id :1;
                        exit ( "导入分卷：&lt;span style='color:#f00;'&gt;" . $tmpfile . '&lt;/span&gt;失败！可能是数据库结构已损坏！请尝试从分卷1开始导入' );
                    }
                } else {
                    $this-&gt;msg .= "此分卷备份全部导入成功！&lt;br /&gt;";
                    return;
                }
                $volume_id ++;
            }
        }if (empty ( $volume [1] )) {
            $this-&gt;_showMsg ( "正在导入sql：&lt;span class='imp'&gt;" . $sqlfile . '&lt;/span&gt;');
            // 没有分卷
            if ($this-&gt;_import ( $sqlfile )) {
                $this-&gt;_showMsg( "数据库导入成功！");
            } else {
                 $this-&gt;_showMsg('数据库导入失败！',true);
                exit ();
            }
        } else {
            // 存在分卷，则获取当前是第几分卷，循环执行余下分卷
            $volume_id = explode ( ".sq", $volume [1] );
            // 当前分卷为$volume_id
            $volume_id = intval ( $volume_id [0] );
            while ( $volume_id ) {
                $tmpfile = $volume_path . "_v" . $volume_id . ".sql";
                // 存在其他分卷，继续执行
                if (file_exists ( $tmpfile )) {
                    // 执行导入方法
                    $this-&gt;msg .= "正在导入分卷 $volume_id ：&lt;span style='color:#f00;'&gt;" . $tmpfile . '&lt;/span&gt;&lt;br /&gt;';
                    if ($this-&gt;_import ( $tmpfile )) {

                    } else {
                        $volume_id = $volume_id ? $volume_id :1;
                        exit ( "导入分卷：&lt;span style='color:#f00;'&gt;" . $tmpfile . '&lt;/span&gt;失败！可能是数据库结构已损坏！请尝试从分卷1开始导入' );
                    }
                } else {
                    $this-&gt;msg .= "此分卷备份全部导入成功！&lt;br /&gt;";
                    return;
                }
                $volume_id ++;
            }
        }
    }

    /**
     * 将sql导入到数据库（普通导入）
     *
     * @param string $sqlfile
     * @return boolean
     */
    private function _import($sqlfile) {
        // sql文件包含的sql语句数组
        $sqls = array ();
        $f = fopen ( $sqlfile, "rb" );
        // 创建表缓冲变量
        $create_table = '';
        while ( ! feof ( $f ) ) {
            // 读取每一行sql
            $line = fgets ( $f );
            // 这一步为了将创建表合成完整的sql语句
            // 如果结尾没有包含';'(即为一个完整的sql语句，这里是插入语句)，并且不包含'ENGINE='(即创建表的最后一句)
            if (! preg_match ( '/;/', $line ) || preg_match ( '/ENGINE=/', $line )) {
                // 将本次sql语句与创建表sql连接存起来
                $create_table .= $line;
                // 如果包含了创建表的最后一句
                if (preg_match ( '/ENGINE=/', $create_table)) {
                    //执行sql语句创建表
                    $this-&gt;_insert_into($create_table);
                    // 清空当前，准备下一个表的创建
                    $create_table = '';
                }
                // 跳过本次
                continue;
            }
            //执行sql语句
            $this-&gt;_insert_into($line);
        }
        fclose ( $f );
        return true;
    }

    //插入单条sql语句
    private function _insert_into($sql){
        if (! mysql_query ( trim ( $sql ) )) {
            $this-&gt;msg .= mysql_error ();
            return false;
        }
    }

    /*
     * -------------------------------数据库导入end---------------------------------
     */

    // 关闭数据库连接
    private function close() {
        mysql_close ( $this-&gt;db );
    }

    // 锁定数据库，以免备份或导入时出错
    private function lock($tablename, $op = "WRITE") {
        if (mysql_query ( "lock tables " . $tablename . " " . $op ))
            return true;
        else
            return false;
    }

    // 解锁
    private function unlock() {
        if (mysql_query ( "unlock tables" ))
            return true;
        else
            return false;
    }

    // 析构
    function __destruct() {
        if($this-&gt;db){
            mysql_query ( "unlock tables", $this-&gt;db );
            mysql_close ( $this-&gt;db );
        }
    }

}
</code></pre>

转自：http://yanue.net/post-19.html
    